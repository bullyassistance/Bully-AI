<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bully AI - Credit Report Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;
    </script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .chat-bubble {
        max-width: 80%;
      }
      .chat-bubble-user {
        background-color: #3b82f6; /* blue-500 */
        color: white;
      }
      .chat-bubble-ai {
        background-color: #e5e7eb; /* gray-200 */
        color: #1f2937; /* gray-800 */
      }
      /* Scrollbar styles for webkit browsers */
      #chat-container::-webkit-scrollbar,
      #analysis-output::-webkit-scrollbar {
        width: 8px;
      }
      #chat-container::-webkit-scrollbar-track,
      #analysis-output::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      #chat-container::-webkit-scrollbar-thumb,
      #analysis-output::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      #chat-container::-webkit-scrollbar-thumb:hover,
      #analysis-output::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Style for the file remove button */
      .remove-file-btn {
        font-size: 1.2rem;
        line-height: 1;
        font-weight: bold;
      }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center h-screen">
    <div
      class="w-full max-w-2xl h-full sm:h-[90vh] sm:max-h-[800px] bg-white rounded-lg shadow-2xl flex flex-col"
    >
      <!-- Header -->
      <div
        class="bg-gray-800 text-white p-4 rounded-t-lg flex items-center justify-between"
      >
        <div>
          <h1 class="text-xl font-bold">Bully AI</h1>
          <p class="text-sm text-gray-300">
            Your Consumer-Law Compliance Assistant
          </p>
        </div>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="text-blue-400"
        >
          <path d="M12 8V4H8" />
          <rect x="4" y="4" width="16" height="16" rx="2" />
          <path d="M2 14h2" />
          <path d="M20 14h2" />
          <path d="M15 2v2" />
          <path d="M9 2v2" />
        </svg>
      </div>

      <!-- Chat Container -->
      <div id="chat-container" class="flex-1 p-4 overflow-y-auto space-y-4">
        <!-- Initial Bot Message -->
        <div class="flex justify-start">
          <div class="chat-bubble chat-bubble-ai p-3 rounded-lg">
            <p class="text-sm" id="opening-message">
              Upload your 3-bureau credit reports (PDF recommended). I'll scan
              for inconsistencies—DOFD, DOLP, charge-off dates, payment-history
              conflicts, and more—then estimate potential case value if a
              violation becomes willful and draft your letters for each step.
              You'll get ready-to-mail docs after we confirm the details.
            </p>
          </div>
        </div>
      </div>

      <!-- Analysis Output Container -->
      <div
        id="analysis-output"
        class="hidden p-4 border-t bg-gray-50 overflow-y-auto"
      >
        <h3 class="font-bold text-lg mb-2">Analysis Complete</h3>
        <div id="analysis-content" class="text-sm space-y-4"></div>
        <div id="download-section" class="hidden mt-4">
          <h4 class="font-semibold mb-2">Download Your Dispute Letters</h4>
          <div class="flex flex-col sm:flex-row gap-2">
            <button
              onclick="openLeadCaptureModal('step1')"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 text-sm w-full"
            >
              Step 1: CRA Dispute
            </button>
            <button
              onclick="openLeadCaptureModal('step2')"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 text-sm w-full"
            >
              Step 2: MOV & ACDV Request
            </button>
            <button
              onclick="openLeadCaptureModal('step3')"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 text-sm w-full"
            >
              Step 3: Furnisher Letter
            </button>
            <button
              onclick="openLeadCaptureModal('step4')"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 text-sm w-full"
            >
              Step 4: Demand Letter
            </button>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="p-4 border-t bg-gray-50 rounded-b-lg">
        <div class="flex items-center space-x-2">
          <input
            type="file"
            id="file-upload"
            class="hidden"
            accept=".pdf,.txt"
            onchange="handleFileUpload(event)"
            multiple
          />
          <button
            onclick="document.getElementById('file-upload').click()"
            class="p-2 text-gray-600 hover:text-blue-600 rounded-full hover:bg-gray-200 transition duration-300"
            aria-label="Upload file"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
          </button>
          <textarea
            id="user-input"
            rows="1"
            class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
            placeholder="Or paste credit report text here..."
          ></textarea>
          <button
            id="send-button"
            onclick="sendMessage()"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold"
          >
            Analyze
          </button>
        </div>
        <div
          id="file-name-container"
          class="mt-2 flex flex-wrap items-center gap-2"
        ></div>
      </div>
    </div>

    <!-- Lead Capture Modal -->
    <div
      id="lead-capture-modal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center"
    >
      <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">Enter Your Information</h2>
        <p class="text-gray-600 mb-6">
          Please provide your details to personalize and download your dispute
          letter.
        </p>
        <form id="lead-capture-form" onsubmit="handleLeadCaptureSubmit(event)">
          <div class="space-y-4">
            <input
              type="text"
              id="user-name"
              placeholder="Full Name"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
            <input
              type="tel"
              id="user-phone"
              placeholder="Phone Number"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
            <input
              type="email"
              id="user-email"
              placeholder="Email Address"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
            <textarea
              id="user-address"
              placeholder="Full Mailing Address"
              rows="3"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
              required
            ></textarea>
          </div>
          <div class="mt-6 flex justify-end space-x-4">
            <button
              type="button"
              onclick="closeLeadCaptureModal()"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
            >
              Submit & Download
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Store generated letters to enable download
      let generatedLetters = {};
      // Store file objects ready for upload
      let stagedFiles = [];
      // Store user data from lead capture form
      let userData = null;
      // Keep track of which download was clicked
      let currentDownloadStep = null;

      function appendMessage(text, sender) {
        const chatContainer = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex ${
          sender === "user" ? "justify-end" : "justify-start"
        }`;

        const bubble = document.createElement("div");
        bubble.className = `chat-bubble p-3 rounded-lg ${
          sender === "user" ? "chat-bubble-user" : "chat-bubble-ai"
        }`;

        const content = document.createElement("p");
        content.className = "text-sm";
        content.innerText = text;

        bubble.appendChild(content);
        messageDiv.appendChild(bubble);
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function showLoadingIndicator() {
        const chatContainer = document.getElementById("chat-container");
        const loadingDiv = document.createElement("div");
        loadingDiv.id = "loading-indicator";
        loadingDiv.className = "flex justify-start";
        loadingDiv.innerHTML = `
                <div class="chat-bubble chat-bubble-ai p-3 rounded-lg flex items-center space-x-2">
                    <div class="loader"></div>
                    <p class="text-sm">Bully AI is analyzing your report...</p>
                </div>
            `;
        chatContainer.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function removeLoadingIndicator() {
        const loadingIndicator = document.getElementById("loading-indicator");
        if (loadingIndicator) {
          loadingIndicator.remove();
        }
      }

      function handleFileUpload(event) {
        const newFiles = event.target.files;
        if (!newFiles || newFiles.length === 0) return;
        stagedFiles.push(...Array.from(newFiles));
        updateStagedFilesUI();
        event.target.value = "";
      }

      function updateStagedFilesUI() {
        const fileNameContainer = document.getElementById(
          "file-name-container"
        );
        fileNameContainer.innerHTML = "";
        if (stagedFiles.length > 0) {
          stagedFiles.forEach((file, index) => {
            const fileTag = document.createElement("div");
            fileTag.className =
              "inline-flex items-center bg-gray-200 text-gray-800 text-xs font-medium px-2.5 py-1 rounded-full";
            const fileName = document.createElement("span");
            fileName.textContent = file.name;
            const removeBtn = document.createElement("button");
            removeBtn.className =
              "ml-2 text-gray-500 hover:text-gray-900 remove-file-btn";
            removeBtn.innerHTML = "&times;";
            removeBtn.setAttribute("aria-label", `Remove ${file.name}`);
            removeBtn.onclick = () => removeStagedFile(index);
            fileTag.appendChild(fileName);
            fileTag.appendChild(removeBtn);
            fileNameContainer.appendChild(fileTag);
          });
        }
      }

      function removeStagedFile(index) {
        stagedFiles.splice(index, 1);
        updateStagedFilesUI();
      }

      async function sendMessage() {
        const userInput = document.getElementById("user-input");
        const reportText = userInput.value.trim();
        if (stagedFiles.length === 0 && !reportText) return;

        let userMessageText = reportText
          ? `Analyzing pasted text and ${stagedFiles.length} uploaded file(s).`
          : `Analyzing ${stagedFiles.length} uploaded file(s): ${stagedFiles
              .map((f) => f.name)
              .join(", ")}`;
        appendMessage(userMessageText, "user");

        showLoadingIndicator();
        document.getElementById("send-button").disabled = true;

        const filesToProcess = [...stagedFiles];
        userInput.value = "";
        stagedFiles = [];
        updateStagedFilesUI();

        const fileReadPromises = filesToProcess.map((file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              if (file.type === "application/pdf") {
                const typedarray = new Uint8Array(e.target.result);
                pdfjsLib
                  .getDocument(typedarray)
                  .promise.then((pdf) => {
                    const pagePromises = Array.from(
                      { length: pdf.numPages },
                      (_, i) =>
                        pdf.getPage(i + 1).then((page) => page.getTextContent())
                    );
                    Promise.all(pagePromises)
                      .then((textContents) => {
                        const pdfText = textContents
                          .map((tc) =>
                            tc.items.map((item) => item.str).join(" ")
                          )
                          .join("\n\n");
                        resolve({ name: file.name, content: pdfText });
                      })
                      .catch(reject);
                  })
                  .catch(reject);
              } else {
                resolve({ name: file.name, content: e.target.result });
              }
            };
            reader.onerror = reject;
            if (file.type === "application/pdf") reader.readAsArrayBuffer(file);
            else reader.readAsText(file);
          });
        });

        try {
          const fileContents = await Promise.all(fileReadPromises);
          let combinedContent = fileContents
            .map(
              (result) =>
                `--- START OF FILE: ${result.name} ---\n\n${result.content}\n\n--- END OF FILE: ${result.name} ---`
            )
            .join("\n\n");
          if (reportText) {
            if (combinedContent) combinedContent += "\n\n";
            combinedContent += `--- START OF PASTED TEXT ---\n\n${reportText}\n\n--- END OF PASTED TEXT ---`;
          }

          const analysisResult = await getAIAnalysis(combinedContent);
          removeLoadingIndicator();
          displayAnalysis(analysisResult);
        } catch (error) {
          removeLoadingIndicator();
          console.error("Error during analysis:", error);
          appendMessage(
            "Sorry, there was an error processing your request. Please check the file formats and try again.",
            "ai"
          );
        } finally {
          document.getElementById("send-button").disabled = false;
        }
      }

      function displayAnalysis(result) {
        const analysisOutput = document.getElementById("analysis-output");
        const analysisContent = document.getElementById("analysis-content");
        const downloadSection = document.getElementById("download-section");
        generatedLetters = result.letters;

        const formatCurrency = (amount) =>
          new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
          }).format(amount);
        const lowEnd =
          result.caseValue && result.caseValue.lowEnd
            ? formatCurrency(result.caseValue.lowEnd)
            : "$0";
        const highEnd =
          result.caseValue && result.caseValue.highEnd
            ? formatCurrency(result.caseValue.highEnd)
            : "$0";

        analysisContent.innerHTML = `
                <div class="bg-white p-3 rounded-lg border">
                    <h4 class="font-semibold text-gray-800">Identified Issues:</h4>
                    <ul class="list-disc list-inside mt-1 text-gray-600">${result.issues
                      .map(
                        (issue) =>
                          `<li><strong>${issue.type}:</strong> ${issue.description} (Account: ${issue.account})</li>`
                      )
                      .join("")}</ul>
                </div>
                <div class="bg-white p-3 rounded-lg border">
                    <h4 class="font-semibold text-gray-800">Case Value Estimate (Willful Violation):</h4>
                    <p class="mt-1 text-gray-600">Based on similar FCRA cases, the potential statutory and punitive damages could range from <strong class="text-blue-600">${lowEnd} to ${highEnd}</strong>. This is an informational estimate, not a guarantee of outcome or legal advice.</p>
                </div>
                <div class="bg-white p-3 rounded-lg border">
                    <h4 class="font-semibold text-gray-800">Overall Strategy:</h4>
                    <p class="mt-1 text-gray-600">${result.strategy}</p>
                </div>
                <div class="bg-white p-3 rounded-lg border">
                    <h4 class="font-semibold text-gray-800">Step-by-Step Letter Sending Instructions:</h4>
                    <div class="mt-1 text-gray-600">${result.letterSendingInstructions.replace(
                      /\n/g,
                      "<br>"
                    )}</div>
                </div>
                <div class="bg-white p-3 rounded-lg border">
                    <h4 class="font-semibold text-gray-800">Recommended Product:</h4>
                     <a href="${
                       result.productLink.url
                     }" target="_blank" class="inline-block mt-2 bg-green-500 text-white px-3 py-1.5 rounded-md hover:bg-green-600 transition duration-300 text-sm font-semibold">${
          result.productLink.text
        }</a>
                </div>`;

        analysisOutput.classList.remove("hidden");
        downloadSection.classList.remove("hidden");
        analysisOutput.scrollTop = 0;
      }

      async function getAIAnalysis(reportText) {
        const apiKey = "sk-5eb8595f31c745f8963c0c1d839e498a";
        const apiUrl = "https://api.deepseek.com/v1/chat/completions";

        const systemPrompt = `You are "Bully AI," a consumer-law compliance assistant for credit report analysis. You are not a lawyer and do not provide legal advice. You provide information and document drafts for educational purposes. You must not hallucinate. If a fact or statute is uncertain, say: "Unable to verify - legal research required." Your name is Bully AI.

            Your task is to analyze provided credit report text, identify inaccuracies under the FCRA, and generate a JSON object with your analysis and four dispute letters.

            **New Rule: Letter Detail**: The generated letters must be comprehensive, detailed, and professional. They should thoroughly explain the nature of the dispute based on the identified issues, reference relevant parts of the FCRA, and clearly state the desired outcome. Do not use generic, short templates. Fill in specific details from the analysis. The letters must include the following placeholders for user data: [Your Name], [Your Address], [Your Phone Number], [Your Email], and [Date].

            Analysis Flow:
            1.  Parse tradelines and identify inaccuracies.
            2.  Provide a case-value monetary range for willful violations (e.g., { "lowEnd": 1000, "highEnd": 5000 }).
            3.  Outline a brief, high-level dispute strategy.
            4.  Provide a detailed, step-by-step guide for sending the letters, including timelines.
            5.  Recommend a product with a link.
            6.  Draft four detailed letters based on the templates below.

            Letter Templates:
            -   Step 1 (Dispute to CRA): Formal letter to the CRA identifying the inaccurate item(s) and requesting reinvestigation under 15 U.S.C. § 1681i.
            -   **Step 2 (MOV & ACDV Request to CRA):** Letter to the CRA requesting the **Method of Verification AND the ACDV (Automated Consumer Dispute Verification) record** for a previously disputed item that was verified, as per 15 U.S.C. § 1681i(a)(6)(B)(iii).
            -   Step 3 (Direct Letter to Furnisher): Letter to the creditor or debt collector disputing the information they are providing.
            -   Step 4 (Demand Letter): A formal demand letter citing noncompliance with FCRA.

            Output Format: Respond ONLY with a valid JSON object.

            Example JSON structure:
            {
              "issues": [ { "account": "XYZ Card / #...1234", "type": "Inaccurate DOFD", "description": "Experian shows DOFD as 01/2022, TransUnion shows 03/2022." } ],
              "caseValue": { "lowEnd": 1000, "highEnd": 5000 },
              "strategy": "The primary inconsistency is the conflicting DOFD. We will challenge this with all bureaus.",
              "letterSendingInstructions": "1. Send the 'Step 1: CRA Dispute' letter to all three credit bureaus via certified mail immediately.\\n2. The bureaus have 30-45 days to respond...",
              "productLink": { "text": "Purchase Our Advanced Dispute Toolkit", "url": "https://www.thebureaubullies.com/product-link" },
              "letters": {
                "step1": "[Your Name]\\n[Your Address]\\n[Your Phone Number]\\n[Your Email]\\n\\n[Date]\\n\\nCredit Bureau Name\\nBureau Address\\n\\nSubject: Formal Dispute... based on the inaccurate DOFD found...",
                "step2": "...", "step3": "...", "step4": "..."
              }
            }`;

        const payload = {
          model: "deepseek-chat",
          messages: [
            { role: "system", content: systemPrompt },
            {
              role: "user",
              content: `Here is the combined text from the user's credit reports: \n\n${reportText}`,
            },
          ],
          response_format: { type: "json_object" },
        };

        const response = await fetch(apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify(payload),
        });

        if (!response.ok)
          throw new Error(
            `API request failed: ${response.status} ${await response.text()}`
          );
        const result = await response.json();
        const jsonString = result.choices[0].message.content;
        const cleanedJsonString = jsonString.replace(/^```json\n|```$/g, "");
        return JSON.parse(cleanedJsonString);
      }

      function openLeadCaptureModal(stepKey) {
        currentDownloadStep = stepKey;
        document
          .getElementById("lead-capture-modal")
          .classList.remove("hidden");
      }

      function closeLeadCaptureModal() {
        document.getElementById("lead-capture-modal").classList.add("hidden");
      }

      function handleLeadCaptureSubmit(event) {
        event.preventDefault();
        userData = {
          name: document.getElementById("user-name").value,
          phone: document.getElementById("user-phone").value,
          email: document.getElementById("user-email").value,
          address: document.getElementById("user-address").value,
        };
        downloadLetter(currentDownloadStep);
        closeLeadCaptureModal();
        document.getElementById("lead-capture-form").reset();
      }

      function downloadLetter(stepKey) {
        if (!userData) {
          openLeadCaptureModal(stepKey);
          return;
        }

        let letterContent = generatedLetters[stepKey];
        if (!letterContent) {
          console.error("Letter content not available for step:", stepKey);
          alert("Sorry, the content for this letter could not be generated.");
          return;
        }

        // Replace placeholders
        const today = new Date().toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        letterContent = letterContent
          .replace(/\[Your Name\]/g, userData.name)
          .replace(/\[Your Address\]/g, userData.address)
          .replace(/\[Your Phone Number\]/g, userData.phone)
          .replace(/\[Your Email\]/g, userData.email)
          .replace(/\[Date\]/g, today);

        const blob = new Blob([letterContent], { type: "application/msword" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `BullyAI_Dispute_Letter_${stepKey}.doc`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      document
        .getElementById("user-input")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        });
    </script>
  </body>
</html>
