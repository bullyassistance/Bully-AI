<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bully AI - Credit Report Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;
    </script>
    <link rel="stylesheet" href="styles.css" />
    <script src="prompt.js"></script>
    <style>
      /* Custom styles to match the new design */
      html,
      body {
        background-color: #000; /* Fallback for the background image */
        height: 100%;
        width: 100%;
        overflow: hidden; /* Prevents scrollbars on the body */
      }
      .main-container {
        background-image: url("images/text-bg-img.jpg"); /* Background image here */
        background-size: cover;
        background-position: center center;
        position: relative; /* Needed for absolute positioning of overlay */
        display: flex; /* Ensure flex properties remain */
        flex-direction: column;
        height: 100vh; /* Full viewport height */
      }
      .background-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(
          255,
          255,
          255,
          0.2
        ); /* Light white overlay (20% opacity) */
        z-index: 1; /* Ensure overlay is behind content */
      }
      .content-wrapper {
        position: relative; /* Position content above the overlay */
        z-index: 2; /* Higher z-index than overlay */
        display: flex;
        flex-direction: column;
        flex: 1; /* Allow content wrapper to take available space */
        min-height: 0; /* Important for flex + overflow */
      }

      .text-clipper {
        background-image: url("images/text-bg-img.jpg");
        background-size: cover;
        background-position: center;
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }
      .chat-bubble-ai {
        background-color: rgba(0, 0, 0, 0.6);
        color: #f3f4f6;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .chat-bubble-user {
        background-color: rgba(0, 0, 0, 0.6);
        color: #ffffff;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .file-tag {
        background-color: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .file-tag .remove-file-btn {
        color: #e5e7eb;
      }
      .file-tag .remove-file-btn:hover {
        color: #fff;
      }
      #user-input::placeholder {
        color: #9ca3af;
      }
    </style>
  </head>
  <body class="bg-black">
    <div class="main-container w-full h-screen shadow-2xl">
      <div class="background-overlay"></div>
      <div class="content-wrapper">
        <div
          id="initial-view"
          class="flex-1 flex flex-col items-center justify-center text-center p-4 text-white"
        >
          <img
            src="images/badge.svg"
            alt="Bully AI Logo"
            class="w-48 h-48 md:w-56 md:h-56 mb-8"
          />
          <div class="text-clipper">
            <h1
              class="text-5xl md:text-6xl font-bold tracking-wider leading-tight"
            >
              MY NAME IS<br />BULLY AI
            </h1>
            <h2 class="text-3xl md:text-4xl font-normal tracking-wide mt-4">
              YOUR CREDIT ASSISTANT
            </h2>
          </div>
          <button
            onclick="document.getElementById('file-upload').click()"
            class="mt-10 bg-black bg-opacity-25 border border-white/30 text-white px-6 py-3 rounded-lg flex items-center space-x-3 hover:bg-opacity-40 transition-colors duration-300"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            <span>Upload your 3 Credit Reports</span>
          </button>
        </div>

        <div
          id="chat-container"
          class="hidden flex-1 p-4 overflow-y-auto space-y-4"
        >
          </div>

        <div class="p-4 border-t border-white/20 bg-transparent">
          <div
            class="bg-black bg-opacity-40 rounded-lg flex items-center space-x-2 p-1"
          >
            <input
              type="file"
              id="file-upload"
              class="hidden"
              accept=".pdf,.txt"
              onchange="handleFileUpload(event)"
              multiple
            />
            <button
              onclick="document.getElementById('file-upload').click()"
              class="p-2 text-gray-300 hover:text-white rounded-full transition duration-300"
              aria-label="Upload file"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <textarea
              id="user-input"
              rows="1"
              class="flex-1 p-2 bg-transparent text-white border-none rounded-lg focus:outline-none focus:ring-0 resize-none"
              placeholder="Send a message..."
            ></textarea>
            <button
              id="send-button"
              onclick="sendMessage()"
              class="bg-transparent text-white p-2 rounded-lg hover:bg-white/10 transition duration-300"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
          <div
            id="file-name-container"
            class="mt-2 flex flex-wrap items-center gap-2"
          ></div>
        </div>
      </div>
    </div>

    <div
      id="lead-capture-modal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50"
    >
      <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">Enter Your Information</h2>
        <p class="text-gray-600 mb-6">
          Please provide your details to personalize and download your dispute
          letter.
        </p>
        <form id="lead-capture-form" onsubmit="handleLeadCaptureSubmit(event)">
          <div class="space-y-4">
            <input
              type="text"
              id="user-name"
              placeholder="Full Name"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
            <input
              type="tel"
              id="user-phone"
              placeholder="Phone Number"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
            <input
              type="email"
              id="user-email"
              placeholder="Email Address"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
            <textarea
              id="user-address"
              placeholder="Full Mailing Address"
              rows="3"
              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
              required
            ></textarea>
          </div>
          <div class="mt-6 flex justify-end space-x-4">
            <button
              type="button"
              onclick="closeLeadCaptureModal()"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
            >
              Submit & Download
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let generatedLetters = {};
      let stagedFiles = [];
      let userData = null;
      let currentDownloadStep = null;

      function appendMessage(text, sender) {
        const chatContainer = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex ${
          sender === "user" ? "justify-end" : "justify-start"
        }`;
        const bubble = document.createElement("div");
        bubble.className = `chat-bubble p-3 rounded-lg ${
          sender === "user" ? "chat-bubble-user" : "chat-bubble-ai"
        }`;
        const content = document.createElement("p");
        content.className = "text-sm";
        content.innerText = text;
        bubble.appendChild(content);
        messageDiv.appendChild(bubble);
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function showLoadingIndicator() {
        const chatContainer = document.getElementById("chat-container");
        const loadingDiv = document.createElement("div");
        loadingDiv.id = "loading-indicator";
        loadingDiv.className = "flex justify-start";
        loadingDiv.innerHTML = `
                <div class="chat-bubble chat-bubble-ai p-3 rounded-lg flex items-center space-x-2">
                    <div class="loader"></div>
                    <p class="text-sm">Bully AI is analyzing your report...</p>
                </div>
            `;
        chatContainer.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function removeLoadingIndicator() {
        const loadingIndicator = document.getElementById("loading-indicator");
        if (loadingIndicator) {
          loadingIndicator.remove();
        }
      }

      function handleFileUpload(event) {
        const newFiles = event.target.files;
        if (!newFiles || newFiles.length === 0) return;
        stagedFiles.push(...Array.from(newFiles));
        updateStagedFilesUI();
        event.target.value = "";
      }

      function updateStagedFilesUI() {
        const fileNameContainer = document.getElementById(
          "file-name-container"
        );
        fileNameContainer.innerHTML = "";
        if (stagedFiles.length > 0) {
          stagedFiles.forEach((file, index) => {
            const fileTag = document.createElement("div");
            fileTag.className =
              "file-tag inline-flex items-center text-xs font-medium px-2.5 py-1 rounded-full";
            const fileName = document.createElement("span");
            fileName.textContent = file.name;
            const removeBtn = document.createElement("button");
            removeBtn.className =
              "ml-2 text-gray-500 hover:text-gray-900 remove-file-btn";
            removeBtn.innerHTML = "&times;";
            removeBtn.setAttribute("aria-label", `Remove ${file.name}`);
            removeBtn.onclick = () => removeStagedFile(index);
            fileTag.appendChild(fileName);
            fileTag.appendChild(removeBtn);
            fileNameContainer.appendChild(fileTag);
          });
        }
      }

      function removeStagedFile(index) {
        stagedFiles.splice(index, 1);
        updateStagedFilesUI();
      }

      async function sendMessage() {
        const userInput = document.getElementById("user-input");
        const reportText = userInput.value.trim();
        if (stagedFiles.length === 0 && !reportText) return;

        const initialView = document.getElementById("initial-view");
        const chatContainer = document.getElementById("chat-container");
        if (!chatContainer.classList.contains("active-chat")) {
          initialView.classList.add("hidden");
          chatContainer.classList.remove("hidden");
          chatContainer.classList.add("active-chat");
          appendMessage(
            "Upload your 3-bureau credit reports (PDF recommended). I'll scan for inconsistencies—DOFD, DOLP, charge-off dates, payment-history conflicts, and more—then estimate potential case value if a violation becomes willful and draft your letters for each step. You'll get ready-to-mail docs after we confirm the details.",
            "ai"
          );
        }

        let userMessageText = reportText
          ? `Analyzing pasted text and ${stagedFiles.length} uploaded file(s).`
          : `Analyzing ${stagedFiles.length} uploaded file(s): ${stagedFiles
              .map((f) => f.name)
              .join(", ")}`;
        if (stagedFiles.length > 0 || reportText) {
          appendMessage(userMessageText, "user");
        }

        showLoadingIndicator();
        document.getElementById("send-button").disabled = true;

        const filesToProcess = [...stagedFiles];
        userInput.value = "";
        stagedFiles = [];
        updateStagedFilesUI();

        const fileReadPromises = filesToProcess.map((file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              if (file.type === "application/pdf") {
                const typedarray = new Uint8Array(e.target.result);
                pdfjsLib
                  .getDocument(typedarray)
                  .promise.then((pdf) => {
                    const pagePromises = Array.from(
                      { length: pdf.numPages },
                      (_, i) =>
                        pdf.getPage(i + 1).then((page) => page.getTextContent())
                    );
                    Promise.all(pagePromises)
                      .then((textContents) => {
                        const pdfText = textContents
                          .map((tc) =>
                            tc.items.map((item) => item.str).join(" ")
                          )
                          .join("\n\n");
                        resolve({ name: file.name, content: pdfText });
                      })
                      .catch(reject);
                  })
                  .catch(reject);
              } else {
                resolve({ name: file.name, content: e.target.result });
              }
            };
            reader.onerror = reject;
            if (file.type === "application/pdf")
              reader.readAsArrayBuffer(file);
            else reader.readAsText(file);
          });
        });

        try {
          const fileContents = await Promise.all(fileReadPromises);
          let combinedContent = fileContents
            .map(
              (result) =>
                `--- START OF FILE: ${result.name} ---\n\n${result.content}\n\n--- END OF FILE: ${result.name} ---`
            )
            .join("\n\n");
          if (reportText) {
            if (combinedContent) combinedContent += "\n\n";
            combinedContent += `--- START OF PASTED TEXT ---\n\n${reportText}\n\n--- END OF PASTED TEXT ---`;
          }

          const analysisResult = await getAIAnalysis(combinedContent);
          removeLoadingIndicator();
          displayAnalysis(analysisResult);
        } catch (error) {
          removeLoadingIndicator();
          console.error("Error during analysis:", error);
          appendMessage(
            "Sorry, there was an error processing your request. Please check the file formats and try again.",
            "ai"
          );
        } finally {
          document.getElementById("send-button").disabled = false;
        }
      }

      function displayAnalysis(result) {
        const chatContainer = document.getElementById("chat-container");
        generatedLetters = result.letters;

        const formatCurrency = (amount) =>
          new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
          }).format(amount);
        const lowEnd =
          result.caseValue && result.caseValue.lowEnd
            ? formatCurrency(result.caseValue.lowEnd)
            : "$0";
        const highEnd =
          result.caseValue && result.caseValue.highEnd
            ? formatCurrency(result.caseValue.highEnd)
            : "$0";

        const analysisContainer = document.createElement("div");
        analysisContainer.className =
          "chat-bubble chat-bubble-ai p-4 rounded-lg";
        analysisContainer.innerHTML = `
          <h3 class="font-bold text-lg mb-2 text-white">Analysis Complete</h3>
          <div class="text-sm space-y-4">
              <div class="bg-white/10 backdrop-blur-sm p-3 rounded-lg border border-white/20 text-white">
                  <h4 class="font-semibold text-gray-100">Identified Issues:</h4>
                  <ul class="list-disc list-inside mt-1 text-gray-300">${result.issues
                    .map(
                      (issue) =>
                        `<li><strong>${issue.type}:</strong> ${issue.description} (Account: ${issue.account})</li>`
                    )
                    .join("")}</ul>
              </div>
              <div class="bg-white/10 backdrop-blur-sm p-3 rounded-lg border border-white/20 text-white">
                  <h4 class="font-semibold text-gray-100">Case Value Estimate (Willful Violation):</h4>
                  <p class="mt-1 text-gray-300">Based on similar FCRA cases, the potential statutory and punitive damages could range from <strong class="text-blue-400">${lowEnd} to ${highEnd}</strong>. This is an informational estimate, not a guarantee of outcome or legal advice.</p>
              </div>
              <div class="bg-white/10 backdrop-blur-sm p-3 rounded-lg border border-white/20 text-white">
                  <h4 class="font-semibold text-gray-100">Overall Strategy:</h4>
                  <p class="mt-1 text-gray-300">${result.strategy}</p>
              </div>
              <div class="bg-white/10 backdrop-blur-sm p-3 rounded-lg border border-white/20 text-white">
                  <h4 class="font-semibold text-gray-100">Step-by-Step Letter Sending Instructions:</h4>
                  <div class="mt-1 text-gray-300">${result.letterSendingInstructions.replace(
                    /\n/g,
                    "<br>"
                  )}</div>
              </div>
              <div class="bg-white/10 backdrop-blur-sm p-3 rounded-lg border border-white/20 text-white">
                  <h4 class="font-semibold text-gray-100">Recommended Product:</h4>
                   <a href="${
                     result.productLink.url
                   }" target="_blank" class="inline-block mt-2 bg-green-500 text-white px-3 py-1.5 rounded-md hover:bg-green-600 transition duration-300 text-sm font-semibold">${
          result.productLink.text
        }</a>
              </div>
          </div>
          <div class="mt-4">
              <h4 class="font-semibold mb-2 text-white">Download Your Dispute Letters</h4>
              <div class="flex flex-col sm:flex-row gap-2">
                  <button onclick="openLeadCaptureModal('step1')" class="bg-black bg-opacity-25 border border-white/30 text-white px-4 py-2 rounded-lg hover:bg-opacity-40 transition duration-300 text-sm w-full">Step 1: CRA Dispute</button>
                  <button onclick="openLeadCaptureModal('step2')" class="bg-black bg-opacity-25 border border-white/30 text-white px-4 py-2 rounded-lg hover:bg-opacity-40 transition duration-300 text-sm w-full">Step 2: MOV & ACDV Request</button>
                  <button onclick="openLeadCaptureModal('step3')" class="bg-black bg-opacity-25 border border-white/30 text-white px-4 py-2 rounded-lg hover:bg-opacity-40 transition duration-300 text-sm w-full">Step 3: Furnisher Letter</button>
                  <button onclick="openLeadCaptureModal('step4')" class="bg-black bg-opacity-25 border border-white/30 text-white px-4 py-2 rounded-lg hover:bg-opacity-40 transition duration-300 text-sm w-full">Step 4: Demand Letter</button>
              </div>
          </div>
        `;

        chatContainer.appendChild(analysisContainer);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      async function getAIAnalysis(reportText, onToken) {
        const emit = typeof onToken === "function" ? onToken : () => {};
        const apiKey = "sk-5eb8595f31c745f8963c0c1d839e498a";
        const apiUrl = "https://api.deepseek.com/v1/chat/completions";

        const systemPrompt = window.BULLY_SYSTEM_PROMPT || "";

        const payload = {
          model: "deepseek-chat",
          messages: [
            { role: "system", content: systemPrompt },
            {
              role: "user",
              content: `Here is the combined text from the user's credit reports: \n\n${reportText}`,
            },
          ],
          response_format: { type: "json_object" },
          stream: true,
        };

        const response = await fetch(apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          const errText = await response.text().catch(() => "");
          throw new Error(`API request failed: ${response.status} ${errText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";
        let fullText = "";
        let finished = false;

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          const lines = buffer.split(/\r?\n/);
          buffer = lines.pop() || "";

          for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed) continue;
            if (trimmed.startsWith("data:")) {
              const dataStr = trimmed.slice(5).trim();
              if (dataStr === "[DONE]") {
                buffer = "";
                finished = true;
                break;
              }
              try {
                const evt = JSON.parse(dataStr);
                const delta = evt?.choices?.[0]?.delta;
                if (delta && typeof delta.content === "string") {
                  fullText += delta.content;
                  emit(delta.content);
                }
              } catch (e) {
                // Ignore JSON parse errors for non-data lines in SSE
              }
            }
          }
          if (finished) break;
        }

        const cleanedJsonString = fullText.replace(/^```json\n|```$/g, "");
        return JSON.parse(cleanedJsonString);
      }

      function openLeadCaptureModal(stepKey) {
        currentDownloadStep = stepKey;
        document
          .getElementById("lead-capture-modal")
          .classList.remove("hidden");
      }

      function closeLeadCaptureModal() {
        document.getElementById("lead-capture-modal").classList.add("hidden");
      }

      function handleLeadCaptureSubmit(event) {
        event.preventDefault();
        userData = {
          name: document.getElementById("user-name").value,
          phone: document.getElementById("user-phone").value,
          email: document.getElementById("user-email").value,
          address: document.getElementById("user-address").value,
        };
        downloadLetter(currentDownloadStep);
        closeLeadCaptureModal();
        document.getElementById("lead-capture-form").reset();
      }

      function downloadLetter(stepKey) {
        if (!userData) {
          openLeadCaptureModal(stepKey);
          return;
        }

        let letterContent = generatedLetters[stepKey];
        if (!letterContent) {
          console.error("Letter content not available for step:", stepKey);
          alert("Sorry, the content for this letter could not be generated.");
          return;
        }

        const today = new Date().toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        letterContent = letterContent
          .replace(/\[Your Name\]/g, userData.name)
          .replace(/\[Your Address\]/g, userData.address)
          .replace(/\[Your Phone Number\]/g, userData.phone)
          .replace(/\[Your Email\]/g, userData.email)
          .replace(/\[Date\]/g, today);

        const blob = new Blob([letterContent], {
          type: "application/msword",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `BullyAI_Dispute_Letter_${stepKey}.doc`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      document
        .getElementById("user-input")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        });
    </script>
  </body>
</html>